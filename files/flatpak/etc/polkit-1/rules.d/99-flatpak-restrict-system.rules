polkit.addRule(function(action, subject) {
    // Allow systemd services to modify system Flatpaks
    if (subject.isSystemBus() || subject.user == "root") {
        return polkit.Result.YES;
    }

    // Block system-wide install, uninstall, and update for regular users
    if (action.id == "org.freedesktop.Flatpak.install" ||
        action.id == "org.freedesktop.Flatpak.uninstall" ||
        action.id == "org.freedesktop.Flatpak.update") {
        if (action.lookup("flatpak.installation") == "system") {
            return polkit.Result.NO;
        }
    }
});