polkit.addRule(function(action, subject) {
    // Allow system services to modify system Flatpaks without authentication
    if (subject.isSystemBus()) {
        return polkit.Result.YES;
    }

    // Require authentication for root and sudo users with a custom message
    if (subject.user == "root" || subject.isInGroup("sudo")) {
        return polkit.Result.AUTH_ADMIN_WITH_MESSAGE("System-wide Flatpak modifications require admin approval.");
    }

    // Block system-wide install, uninstall, and update for regular users
    if (action.id == "org.freedesktop.Flatpak.install" ||
        action.id == "org.freedesktop.Flatpak.uninstall" ||
        action.id == "org.freedesktop.Flatpak.update") {
        if (action.lookup("flatpak.installation") == "system") {
            // Log a message and deny the action
            polkit.log("flatpak --system commands are disabled for regular users.");
            return polkit.Result.NO;
        }
    }
});