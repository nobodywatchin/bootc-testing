//
// consolidated org.freedesktop.Flatpak polkit rules
// Behavior:
// - System-wide Flatpak ops: only wheel can do them, and they MUST authenticate (AUTH_ADMIN).
//   Non-wheel users get a hard NO.
// - AppStream / metadata refresh: allowed for local, active users without password
//   (so GUIs like Bazaar can sync).
// - Parental controls override: only wheel with AUTH_ADMIN.
// - No silent YES for installs/uninstalls; admin group is mapped to wheel.
//

polkit.addAdminRule(function (action, subject) {
    // Treat members of unix group "wheel" as admins for auth prompts
    return [ "unix-group:wheel" ];
});

polkit.addRule(function (action, subject) {
    // Flatpak system-level actions governed by this policy
    const sysActs = new Set([
        "org.freedesktop.Flatpak.app-install",
        "org.freedesktop.Flatpak.runtime-install",
        "org.freedesktop.Flatpak.app-uninstall",
        "org.freedesktop.Flatpak.runtime-uninstall",
        "org.freedesktop.Flatpak.install-bundle",
        "org.freedesktop.Flatpak.modify-repo",
        "org.freedesktop.Flatpak.configure-remote"
    ]);

    // Require wheel + authentication for system-level changes
    if (sysActs.has(action.id)) {
        if (!subject.isInGroup("wheel")) {
            return polkit.Result.NO;
        }
        return polkit.Result.AUTH_ADMIN;
    }

    // Allow refreshing AppStream/metadata so GUIs (e.g., Bazaar) can see system remotes
    if (action.id == "org.freedesktop.Flatpak.appstream-update" ||
        action.id == "org.freedesktop.Flatpak.metadata-update" ||
        action.id == "org.freedesktop.Flatpak.DeployAppstream") {
        // Permit for local, active user sessions without password
        if (subject.local === true && subject.active === true) {
            return polkit.Result.YES;
        }
        // Otherwise allow with admin auth (wheel)
        if (subject.isInGroup("wheel")) {
            return polkit.Result.AUTH_ADMIN;
        }
        return polkit.Result.NO;
    }

    // Parental controls override is admin-only with authentication
    if (action.id == "org.freedesktop.Flatpak.override-parental-controls") {
        if (!subject.isInGroup("wheel")) {
            return polkit.Result.NO;
        }
        return polkit.Result.AUTH_ADMIN;
    }

    // Anything else falls through to other rules (if any)
    return polkit.Result.NOT_HANDLED;
});
