modules:
  # 1) Enable RPM Fusion (EL10)
  - type: dnf
    repos:
      keys:
        - https://download1.rpmfusion.org/free/el/RPM-GPG-KEY-rpmfusion-free-el-10
        - https://download1.rpmfusion.org/nonfree/el/RPM-GPG-KEY-rpmfusion-nonfree-el-10
    install:
      packages:
        - https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-10.noarch.rpm
        - https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-10.noarch.rpm

  # 2) Install wl stack (akmod path)
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        - broadcom-wl
        - iw
        - wpa_supplicant

  # 3) Make wl the only Broadcom stack and keep image deterministic
  - type: containerfile
    snippets:
      - |
        # Remove any akmods bits that may have been dragged in earlier layers/images
        RUN dnf -y remove akmods akmod-wl broadcom-wl || true

        # Prefer wl over in-kernel drivers
        RUN printf '%s\n' "blacklist b43" "blacklist brcmsmac" "blacklist brcmfmac" \
          > /usr/lib/modprobe.d/blacklist-broadcom.conf
        RUN printf '%s\n' wl > /usr/lib/modules-load.d/wl.conf

        # Optional: mask akmods keygen to guarantee it never fires if akmods reappears
        RUN systemctl mask akmods-keygen@akmods-keygen.service || true

        # Make sure initramfs wonâ€™t pre-load b43/brcm*; and include wl if needed
        RUN dracut -f

        # Clean out RPM Fusion repos post-install (packages stay)
        RUN set -euo pipefail; \
            if command -v dnf5 >/dev/null 2>&1; then CM="dnf5 config-manager"; else CM="dnf config-manager"; fi; \
            $CM --set-disabled 'rpmfusion-*' || true; \
            dnf -y remove 'rpmfusion-*-release' || true; \
            rm -f /etc/yum.repos.d/rpmfusion-*.repo || true