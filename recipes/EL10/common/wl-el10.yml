modules:
  # 1) Enable RPM Fusion (EL10)
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        - https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm
        - dkms
        - kernel-devel
        - kernel-headers
        - gcc
        - make
        - binutils
        - elfutils-libelf-devel
        - bc
        - patch
        - NetworkManager-wifi
        - wpa_supplicant
        - rfkill
        - iw

  # 2) Clone the patched repo into the exact DKMS path
  - type: containerfile
    snippets:
      - ARG WL_REPO=https://github.com/csabika98/broadcom-wl-patched.git
      - ARG WL_REV=main
      - |
        RUN --mount=type=cache,target=/root/.cache \
            git clone --depth=1 --branch "$WL_REV" "$WL_REPO" /tmp/wl-patched && \
            rm -rf /usr/src/broadcom-wl-6.30.223.271 && \
            mkdir -p /usr/src/broadcom-wl-6.30.223.271 && \
            cp -a /tmp/wl-patched/* /usr/src/broadcom-wl-6.30.223.271/ && \
            chown -R root:root /usr/src/broadcom-wl-6.30.223.271 && \
            find /usr/src/broadcom-wl-6.30.223.271 -type f -exec chmod 0644 {} \; && \
            find /usr/src/broadcom-wl-6.30.223.271 -type d -exec chmod 0755 {} \; && \
            rm -rf /tmp/wl-patched

      # 3) Ensure conflicting drivers are blacklisted (repo README lists them)
      - |
        RUN printf '%s\n' \
          'blacklist ssb' \
          'blacklist bcma' \
          'blacklist b43' \
          'blacklist brcmsmac' \
          > /etc/modprobe.d/blacklist-broadcom-wl.conf

      # 4) First-boot DKMS setup: add/build/install for the running kernel, then load wl
      - |
        RUN printf '%s\n' \
          '[Unit]' \
          'Description=DKMS: build & load Broadcom wl on first boot' \
          'After=local-fs.target systemd-udev-settle.service' \
          'Before=NetworkManager.service' \
          'ConditionPathExists=!/run/wl-dkms-setup.done' \
          '' \
          '[Service]' \
          'Type=oneshot' \
          'RemainAfterExit=yes' \
          "ExecStart=/usr/bin/bash -ec 'set -o pipefail; \
             if ! dkms status broadcom-wl/6.30.223.271 | grep -q installed; then \
               dkms add -m broadcom-wl -v 6.30.223.271 || true; \
               dkms build -m broadcom-wl -v 6.30.223.271 -k \"\$(uname -r)\"; \
               dkms install -m broadcom-wl -v 6.30.223.271 -k \"\$(uname -r)\"; \
             fi; \
             for m in b43 bcma brcmsmac; do /usr/sbin/modprobe -r \"\$m\" 2>/dev/null || true; done; \
             /usr/sbin/depmod -a; \
             /usr/sbin/modprobe wl || true; \
             touch /run/wl-dkms-setup.done'" \
          '' \
          '[Install]' \
          'WantedBy=multi-user.target' \
          > /usr/lib/systemd/system/wl-dkms-setup.service
      - RUN systemctl enable wl-dkms-setup.service