---
modules:
  - type: containerfile
    snippets:
      - |
        RUN set -euo pipefail; \
          DNF="$(command -v dnf || command -v dnf5 || true)"; \
          if [ -z "$DNF" ]; then echo "dnf/dnf5 not found in this image"; exit 1; fi; \
          EL="$(rpm -E %rhel)"; \
          \
          # Make sure we have EPEL (often needed) + gpg key package if available
          $DNF -y install epel-release distribution-gpg-keys || true; \
          $DNF config-manager --set-enabled crb || true; \
          \
          # --- Import RPM Fusion NONFREE key (try local from distribution-gpg-keys, else mirror) ---
          KEY_LOCAL="/usr/share/distribution-gpg-keys/rpmfusion/RPM-GPG-KEY-rpmfusion-nonfree-el-${EL}"; \
          KEY_URL="https://mirrors.rpmfusion.org/nonfree/el/updates/${EL}/x86_64/repodata/repomd.xml.key"; \
          if [ -f "$KEY_LOCAL" ]; then rpm --import "$KEY_LOCAL"; else rpm --import "$KEY_URL"; fi; \
          \
          # --- (Optional but safe) Import FREE key similarly in case deps ever touch it ---
          KEYF_LOCAL="/usr/share/distribution-gpg-keys/rpmfusion/RPM-GPG-KEY-rpmfusion-free-el-${EL}"; \
          KEYF_URL="https://mirrors.rpmfusion.org/free/el/updates/${EL}/x86_64/repodata/repomd.xml.key"; \
          if [ -f "$KEYF_LOCAL" ]; then rpm --import "$KEYF_LOCAL"; else rpm --import "$KEYF_URL"; fi; \
          \
          # --- Add RPM Fusion NONFREE release rpm (use updates/x86_64/r path that actually exists) ---
          $DNF -y --setopt=localpkg_gpgcheck=1 install \
            "https://mirrors.rpmfusion.org/nonfree/el/updates/${EL}/x86_64/r/rpmfusion-nonfree-release-${EL}-1.noarch.rpm"; \
          \
          # --- Install Broadcom wl stack (minimal deps) ---
          $DNF -y --setopt=install_weak_deps=False --enablerepo=rpmfusion-nonfree \
            install broadcom-wl akmod-wl akmods kernel-devel kernel-headers; \
          \
          # --- Remove RPM Fusion repos/keys to avoid future conflicts (e.g., Negativo17) ---
          rm -f /etc/yum.repos.d/rpmfusion-*.repo || true; \
          rm -f /etc/pki/rpm-gpg/RPM-GPG-KEY-rpmfusion-* || true; \
          $DNF clean all