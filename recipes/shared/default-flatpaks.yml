---
modules:
  # 0) Nuke any vendor system remotes so we fully control names/scope
  - type: containerfile
    snippets:
      - RUN rm -f /usr/share/flatpak/remotes.d/*.flatpakrepo || true
      - RUN rm -f /etc/flatpak/remotes.d/*.flatpakrepo || true

  # 1) Default Flatpaks: user-visible Flathub + hidden system remote (different name)
  - type: default-flatpaks
    configurations:
      # User repo (visible) → GUI/CLI default to per-user without prompts
      - scope: user
        notify: true
        repo:
          url: https://dl.flathub.org/repo/flathub.flatpakrepo
          name: flathub
          title: Flathub (user)

      # System repo (managed) → different name; we’ll hide it after boot
      - scope: system
        notify: true
        repo:
          url: https://dl.flathub.org/repo/flathub.flatpakrepo
          name: org-system
          title: Flathub (system, managed)
        install:
          - com.github.marhkb.Pods
          - io.github.dvlv.boxbuddyrs
          - com.github.tchx84.Flatseal
          - io.github.giantpinkrobots.flatsweep
          - it.mijorus.gearlever
          - com.usebottles.bottles
          - net.nokyan.Resources
          - com.mattjakeman.ExtensionManager
          - org.gnome.Decibels
          - org.gnome.Showtime
          - org.gnome.FileRoller

  # 2) Copy your whole flatpak/ tree (polkit rule, tmpfiles, overrides, units, scripts, Brave policy)
  - type: files
    files:
      - source: flatpak
        destination: /

  # 3) Enable the units we shipped:
  #    - myos-hide-org-system.service → marks system remote no-enumerate after boot
  #    - myos-flatpak-setup.service  → adds user "flathub" on first login per-user
  - type: systemd
    system:
      enabled:
        - myos-hide-org-system.service
    user:
      enabled:
        - myos-flatpak-setup.service
