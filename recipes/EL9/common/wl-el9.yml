modules:
  # 1) Enable RPM Fusion (EL9)
  - type: dnf
    repos:
      keys:
        - https://download1.rpmfusion.org/free/el/RPM-GPG-KEY-rpmfusion-free-el-9
        - https://download1.rpmfusion.org/nonfree/el/RPM-GPG-KEY-rpmfusion-nonfree-el-9
    install:
      packages:
        - https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-9.noarch.rpm
        - https://mirrors.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-9.noarch.rpm

  # 2) wl via akmods + build deps (flat, minimal)
  - type: dnf
    install:
      install-weak-deps: false
      packages:
        - akmods
        - akmod-wl
        - broadcom-wl
        - kernel-headers
        - gcc
        - make
        - binutils
        - elfutils-libelf-devel
        - bc
        - patch
        - wpa_supplicant
        - rfkill
        - iw
        - mokutil
        - perl

  # 3) Add custom wl service and script
  - type: files 
    files:
      - source: wl 
        destination: /

  # 4) Give script permissions to run; disable RPM Fusion repos post-install
  - type: containerfile
    snippets:
      - RUN chmod 0755 /usr/local/sbin/wl-akmods-build.sh
      - RUN chmod 0755 /usr/local/sbin/needs-wl.sh
      - RUN semanage fcontext -a -t modules_object_t '/var/lib/wl-mount(/.*)?'
      - RUN restorecon -Rv /var/lib/wl-mount
      - RUN rm -f /etc/yum.repos.d/rpmfusion-*.repo

  # 5) Enable custom service
  - type: systemd
    system:
      enabled:
        - wl-akmods-load.service